<beast version='2.0'
       namespace='beast.core
                 :beast.core.util
                 :beast.core.parameter
                 :beast.evolution.operators
                 :beast.evolution.sitemodel
                 :beast.evolution.substitutionmodel
                 :beast.evolution.tree
                 :beast.evolution.tree.coalescent
                 :beast.math.distributions
                 :beast.util
                 :bacter
                 :bacter.model:bacter.model.restricted
                 :bacter.operators:bacter.operators.restricted
                 :bacter.util'>


  <!-- Simulated ACG (Truth) -->  

  <input spec='SimulatedRestrictedACG' id='acgTruth'
         rho="0.0005" delta="500.0" sequenceLength="10000" nTaxa="20"
	 outputFileName="simulated_acg.nexus">
      <populationModel spec='ConstantPopulation' popSize="1.0"/>
  </input>

  <!-- Simulated Alignment (Truth) -->

  <input spec='SimulatedAlignment' id='alignment' acg="@acgTruth"
	 outputFileName="simulated_alignment.nexus" useNexus="true">
    <siteModel spec='SiteModel' mutationRate="0.1">
      <substModel spec='JukesCantor'/>
    </siteModel>
  </input>


  <run spec="MCMC" id="mcmc" chainLength="10000000">
    <state>
      <stateNode id="acg" spec='SimulatedRestrictedACG'
		 alignment="@alignment" rho="0.0005" delta="500.0">
	<populationModel spec='ConstantPopulation' popSize="5.0"/>
      </stateNode>

      <stateNode id="rho" spec='RealParameter' value="0.0005" />
      <stateNode id="delta" spec='RealParameter' value="500.0"/>
      <stateNode id="popSize" spec='RealParameter' value="5.0"/>
      <stateNode id="mutationRate" spec='RealParameter' value="0.1"/>
    </state>


    <!-- Posterior -->    

    <distribution spec="CompoundDistribution" id="posterior">

      <!-- ACG likelihood --> 

      <distribution spec='ACGLikelihood' id="acgLikelihood"
		    acg="@acg" data="@alignment">
	<siteModel spec='SiteModel' mutationRate="@mutationRate">
	  <substModel spec='JukesCantor'/>
	</siteModel>
      </distribution>

      <!-- ACG prior -->

      <distribution spec='RestrictedACGCoalescent' id="acgPrior" rho="@rho" delta="@delta">
	<acg idref="acg"/>
	<populationModel spec='ConstantPopulation' popSize='@popSize' id='popModel'/>
      </distribution>

      <!-- Parameter priors -->

      <distribution spec='Prior' x='@rho'>
	<!--distr spec='OneOnX'/-->
	<distr spec='LogNormalDistributionModel' M='0.0' S='2.0'/>
      </distribution>
      <distribution spec='Prior' x='@delta'>
	<!--distr spec='OneOnX'/-->
	<distr spec='LogNormalDistributionModel' M='0.0' S='2.0'/>
      </distribution>
      <distribution spec='Prior' x='@popSize'>
	<distr spec='OneOnX'/>
	<!--distr spec='LogNormalDistributionModel' M='0.0' S='4.0'/-->
      </distribution>
      <distribution spec='Prior' x='@mutationRate'>
	<!--distr spec='OneOnX'/-->
	<distr spec='LogNormalDistributionModel' M='0.0' S='2.0'/>
      </distribution>

    </distribution>


    <!-- Parameter operators -->

    <!--operator id="rhoScaler" spec="ScaleOperator" weight="1.0"
	      scaleFactor="0.8" parameter="@rho"/-->

    <!--operator id="deltaScaler" spec="ScaleOperator" weight="1.0"
	      scaleFactor="0.8" parameter="@delta"/-->

    <operator id="popSizeScaler" spec="ScaleOperator" weight="1.0"
	      scaleFactor="0.8" parameter="@popSize"/>

    <!--operator id="mutationRateScaler" spec="ScaleOperator" weight="1.0"
	      scaleFactor="0.8" parameter="@mutationRate"/-->


    <!-- ACG operators -->

    <operator id="addRemove" spec="AddRemoveConversion" weight="1.0">
        <acg idref="acg"/>
        <rho idref="rho"/>
        <delta idref="delta"/>
        <populationModel idref="popModel"/>
    </operator>

    <operator id="mergeSplit" spec="MergeSplitConversion" weight="1.0"
              expectedGapSize="200" acg="@acg" />
    
    <operator id="scale" spec="ACGScaler" weight="1.0"
              scaleFactor="0.8">
        <acg idref="acg"/>
    </operator>

    <operator id="CFRSwap" spec="ClonalFrameConversionSwap" weight="1.0"
              acg="@acg" populationModel="@popModel"/>
    
    <operator id="CRswap" spec="ConvertedRegionSwap" weight="1.0"
              acg="@acg"/>

    <operator id="CRshift" spec="ConvertedRegionShift" weight="1.0"
              acg="@acg" apertureSize="0.01" />

    <operator id="CRBshift" spec="ConvertedRegionBoundaryShift" weight="1.0"
              acg="@acg" apertureSize="0.01" />

    <operator id="REhop" spec="ConvertedEdgeHop" weight="1.0"
              acg="@acg" />

   <operator id="REflip" spec="ConvertedEdgeFlip" weight="1.0"
              acg="@acg" />

    <operator id="REslide" spec="ConvertedEdgeSlide" weight="1.0"
              acg="@acg" scaleBound="0.8" />
    
    <operator id="Uniform" spec='ACGValidityWrapper' acg="@acg" weight="1">
        <operator spec='Uniform' weight="10">
            <tree idref="acg"/>
        </operator>
    </operator>
    <operator id="STS" spec='ACGValidityWrapper' acg="@acg" weight="1">
        <operator spec='SubtreeSlide' weight="5" gaussian="true" size="1.0">
            <tree idref="acg"/>
        </operator>
    </operator>
    <operator id="STXnarrow" spec='ACGValidityWrapper' acg="@acg" weight="1">
        <operator id='narrow' spec='Exchange' isNarrow='true' weight="1">
            <tree idref="acg"/>
        </operator>
    </operator>
    <operator id="STXwide" spec='ACGValidityWrapper' acg="@acg" weight="1">
        <operator id='wide' spec='Exchange' isNarrow='false' weight="1">
            <tree idref="acg"/>
        </operator>
    </operator>
    <operator id="WB" spec='ACGValidityWrapper' acg="@acg" weight="1">
        <operator spec='WilsonBalding' weight="1">
            <tree idref="acg"/>
        </operator>
    </operator>

   
    <!-- Output logging -->

    <logger logEvery="10000">
      <log idref="posterior"/>
      <log spec='TreeHeightLogger' tree="@acg"/>
      <log idref='rho'/>
      <log idref='delta'/>
      <log idref='popSize'/>
      <log idref='mutationRate'/>
    </logger>

    <logger logEvery="100" fileName="$(filebase).log">
      <model idref='posterior'/>
      <log idref="posterior"/>
      <log spec='TreeHeightLogger' tree="@acg"/>
      <log idref='rho'/>
      <log idref='delta'/>
      <log idref='popSize'/>
      <log idref='mutationRate'/>
    </logger>

    <logger logEvery="1000" fileName="$(filebase).trees" mode="tree">
      <log idref="acg"/>
    </logger>

    <logger logEvery="1000" fileName="$(filebase).cf" mode="tree">
      <log spec="ClonalFrameLogger" acg="@acg"/>
    </logger>
	 
    <logger logEvery="100" fileName="$(filebase).converted">
      <model idref="posterior"/>
      <log spec="ConvertedRegionLogger" acg="@acg"/>
    </logger>


     <logger logEvery="100" fileName="$(filebase).stats">
         <log spec="ConversionGraphStatsLogger" acg="@acg"/>
     </logger>

  </run>

</beast>
